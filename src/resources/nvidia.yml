modules:
  - name: Install nvidia module
    type: kernel
    body:
      modules:
        - nvidia

  - name: Copy NV root
    type: copy
    body:
      source: root-nv
      destination: /
      replace: true

  - type: packages
    body:
      install:
        - blacklist-nouveau
        - libcuda
        - libnvcuvid
        - libnvidia-container-tools
        - libnvidia-container1
        - libnvidia-encode
        - libnvidia-opticalflow
        - libnvidia-vksc-core
        - libnvoptix
        - nvidia-modprobe
        - nvidia-powerd
        - nvidia-settings
        - nvidia-settings
        - nvidia-smi
        - nvidia-vaapi-driver
        - ocl-nvidia
        - switcheroo-control

  - type: replace
    body:
      target: /etc/modprobe.d/nvidia_common.conf
      pattern: ^#?(options nvidia NVreg_PreserveVideoMemoryAllocations=).*
      repl: $11

  - type: systemd
    body:
      targets:
        - nvidia-suspend
        - nvidia-hibernate
        - nvidia-suspend-then-hibernate
        - nvidia-resume
        - nvidia-powerd
        - switcheroo-control
      enabled: true
